<div class="min-h-screen bg-secondary-50">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-primary-900 mb-2">Reports & Analytics</h1>
        <p class="text-secondary-600">View detailed sales and expense reports</p>
      </div>
    </div>

    <!-- Date Range Filter -->
    <%= form_with url: reports_path, method: :get, local: true, class: "bg-white rounded-lg shadow p-6 mb-8" do |f| %>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <div>
          <%= f.label :start_date, "Start Date", class: "block text-sm font-medium text-primary-700 mb-2" %>
          <%= f.date_field :start_date, value: @start_date, class: "w-full px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none" %>
        </div>
        <div>
          <%= f.label :end_date, "End Date", class: "block text-sm font-medium text-primary-700 mb-2" %>
          <%= f.date_field :end_date, value: @end_date, class: "w-full px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none" %>
        </div>
        <div>
          <%= f.submit "Apply Filter", class: "w-full bg-primary-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-primary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2" %>
        </div>
        <div>
          <%= link_to "Reset", reports_path, class: "w-full block text-center bg-secondary-200 text-secondary-800 font-semibold py-3 px-6 rounded-lg hover:bg-secondary-300 transition-colors" %>
        </div>
      </div>
    <% end %>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <%= render StatCardComponent.new(
            label: "Total Revenue",
            value: number_to_currency(@total_revenue, unit: "Rs. ", separator: ".", delimiter: ",")
          ) %>
      <%= render StatCardComponent.new(
            label: "Total Profit",
            value: number_to_currency(@total_profit, unit: "Rs. ", separator: ".", delimiter: ",")
          ) %>
      <%= render StatCardComponent.new(
            label: "Total Expenses",
            value: number_to_currency(@total_expenses, unit: "Rs. ", separator: ".", delimiter: ",")
          ) %>
      <%= render StatCardComponent.new(
            label: "Net Profit",
            value: number_to_currency(@net_profit, unit: "Rs. ", separator: ".", delimiter: ","),
            subtitle: @net_profit >= 0 ? "Positive" : "Negative"
          ) %>
    </div>

    <!-- Export Buttons -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <h2 class="text-xl font-semibold text-primary-900 mb-4">Export Reports</h2>
      <div class="flex flex-wrap gap-4">
        <%= link_to bulk_export_reports_path(format: :xlsx),
            class: "inline-flex items-center px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors text-base" do %>
          ðŸ“¦ Full Bulk Export (All Data)
        <% end %>
        <%= link_to export_reports_path(start_date: @start_date, end_date: @end_date, report_type: "sales", format: :xlsx),
            class: "inline-flex items-center px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors" do %>
          ðŸ“Š Export Sales Report (Excel)
        <% end %>
        <%= link_to export_reports_path(start_date: @start_date, end_date: @end_date, report_type: "expenses", format: :xlsx),
            class: "inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors" do %>
          ðŸ’° Export Expenses Report (Excel)
        <% end %>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Sales Summary -->
      <%= render CardComponent.new(title: "Sales Summary") do %>
        <dl class="space-y-4">
          <div class="flex justify-between">
            <dt class="text-secondary-600">Total Sales</dt>
            <dd class="font-semibold text-primary-900"><%= @total_sales_count %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-secondary-600">Average Sale Amount</dt>
            <dd class="font-semibold text-primary-900">
              <%= number_to_currency(@average_sale_amount, unit: "Rs. ", separator: ".", delimiter: ",") %>
            </dd>
          </div>
          <div class="pt-4 border-t border-secondary-200">
            <dt class="text-sm font-medium text-secondary-600 mb-2">Payment Method Breakdown</dt>
            <div class="space-y-2">
              <% @payment_method_breakdown.each do |method, amount| %>
                <div class="flex justify-between">
                  <span class="text-secondary-700 capitalize"><%= method.humanize %></span>
                  <span class="font-semibold text-primary-900">
                    <%= number_to_currency(amount, unit: "Rs. ", separator: ".", delimiter: ",") %>
                  </span>
                </div>
              <% end %>
            </div>
          </div>
        </dl>
      <% end %>

      <!-- Expense Breakdown -->
      <%= render CardComponent.new(title: "Expense Breakdown") do %>
        <% if @expense_breakdown.any? %>
          <div class="space-y-3">
            <% @expense_breakdown.each do |category, amount| %>
              <div class="flex items-center justify-between p-3 bg-secondary-50 rounded-lg">
                <span class="font-medium text-primary-900 capitalize"><%= category %></span>
                <span class="text-lg font-semibold text-primary-600">
                  <%= number_to_currency(amount, unit: "Rs. ", separator: ".", delimiter: ",") %>
                </span>
              </div>
            <% end %>
            <div class="pt-3 border-t border-secondary-200">
              <div class="flex items-center justify-between">
                <span class="font-bold text-primary-900">Total</span>
                <span class="text-xl font-bold text-primary-600">
                  <%= number_to_currency(@total_expenses, unit: "Rs. ", separator: ".", delimiter: ",") %>
                </span>
              </div>
            </div>
          </div>
        <% else %>
          <p class="text-secondary-600">No expenses in this period.</p>
        <% end %>
      <% end %>
    </div>

    <!-- Top Products by Revenue -->
    <%= render CardComponent.new(title: "Top Products by Revenue", class: "mb-8") do %>
      <% if @top_products_by_revenue.any? %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-secondary-200">
            <thead class="bg-secondary-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">
                  Product
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">
                  Units Sold
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">
                  Revenue
                </th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-secondary-500 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-secondary-200">
              <% @top_products_by_revenue.each do |product| %>
                <tr class="hover:bg-secondary-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-primary-900">
                    <%= product.name %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-700">
                    <%= product.units_sold.to_i %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-primary-900">
                    <%= number_to_currency(product.revenue, unit: "Rs. ", separator: ".", delimiter: ",") %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <%= render Buttons::OutlineComponent.new(size: :sm, href: product_path(product)) do %>
                      View
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-secondary-600">No sales data in this period.</p>
      <% end %>
    <% end %>

    <!-- Top Customers by Spending -->
    <%= render CardComponent.new(title: "Top Customers by Spending", class: "mb-8") do %>
      <% if @top_customers_by_spending.any? %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-secondary-200">
            <thead class="bg-secondary-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">
                  Customer
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">
                  Purchases
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">
                  Total Spent
                </th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-secondary-500 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-secondary-200">
              <% @top_customers_by_spending.each do |customer| %>
                <tr class="hover:bg-secondary-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-primary-900">
                    <%= customer.full_name %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-700">
                    <%= customer.purchase_count %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-primary-900">
                    <%= number_to_currency(customer.total_spent, unit: "Rs. ", separator: ".", delimiter: ",") %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <%= render Buttons::OutlineComponent.new(size: :sm, href: customer_path(customer)) do %>
                      View
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-secondary-600">No customer data in this period.</p>
      <% end %>
    <% end %>
  </div>
</div>

